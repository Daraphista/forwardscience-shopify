<!-- /templates/customers/register.liquid -->
<div class="full__page__form__wrapper">
  <div class="wrapper">
    <div class="grid">
      <div class="grid__item medium-up--one-half medium-up--push-one-quarter text-center">
        <div class="full__page__form">
          <h1 class="account__form__title">{{ 'customer.register.title' | t }}</h1>

          <style>
            .pro-only-alert {
              border-radius: 6px;
              border-color: #2b9486;
              border-width: 3px;
              padding: 14px 20px;
              margin-bottom: 14px;
              color: #3a6b64;
              background-color: #bee0db;
            }
          </style>
          <!-- REVERT -->
          <div class="pro-only-alert">
            <b>Account Requirements:</b><br>
            Products only available to medical professionals. NPI or license number required. Non-professional orders
            will not be fulfilled.
          </div>

          {% form 'create_customer', id: 'CreateCustomerForm', onSubmit: 'handleCreateCustomerFormSubmit(event)' %}
            {{ form.errors | default_errors }}

            <div class="float__wrapper">
              <label for="FirstName">{{ 'customer.register.first_name' | t }}</label>
              <input
                type="text"
                name="customer[first_name]"
                id="FirstName"
                placeholder="{{ 'customer.register.first_name' | t }}"
                {% if form.first_name %}
                  value="{{ form.first_name }}"
                {% endif %}
                autofocus
              >
            </div>

            <div class="float__wrapper">
              <label for="LastName">{{ 'customer.register.last_name' | t }}</label>
              <input
                type="text"
                name="customer[last_name]"
                id="LastName"
                placeholder="{{ 'customer.register.last_name' | t }}"
                {% if form.last_name %}
                  value="{{ form.last_name }}"
                {% endif %}
              >
            </div>

            <div class="float__wrapper">
              <label for="customer[note][NPI number]"
                >NPI or License Number
                <span style="display:inline-block;font-size:12px; padding: 0px 4px; background:#cc0000;color:white;margin-left:4px;"
                  >REQUIRED</span
                ></label
              >
              <input
                type="text"
                name="customer[note][NPI number]"
                id="NPI"
                placeholder="NPI or License Number"
                required
              >
              <style>
                .npi-verification-status {
                  font-size: 0.75em;
                  margin-top: -12px;
                  text-align: left;
                }

                .npi-verification-status .hidden,
                .npi-verification-status.hidden {
                  display: none;
                }

                .npi-verification-status .loading:after {
                  overflow: hidden;
                  display: inline-block;
                  vertical-align: bottom;
                  -webkit-animation: ellipsis steps(4, end) 900ms infinite;
                  animation: ellipsis steps(4, end) 900ms infinite;
                  content: '\2026';
                  /* ascii code for the ellipsis character */
                  width: 0px;
                }

                @keyframes ellipsis {
                  to {
                    width: 14px;
                  }
                }

                @-webkit-keyframes ellipsis {
                  to {
                    width: 14px;
                  }
                }

                .npi-verification-status .valid {
                  color: #2b9486;
                }

                .npi-verification-status .invalid {
                  color: #cc0000;
                }
              </style>
              <div class="npi-verification-status hidden">
                <span class="loading hidden">Verifying NPI number</span>
                <span class="valid hidden">Valid NPI number</span>
                <span class="invalid hidden">Invalid NPI number</span>
              </div>
            </div>

            <div class="float__wrapper">
              <label for="Email">{{ 'customer.register.email' | t }}</label>
              <input
                type="email"
                name="customer[email]"
                id="Email"
                placeholder="{{ 'customer.register.email' | t }}"
                {% if form.errors contains 'email' %}
                  class="error"
                {% elsif form.email %}
                  value="{{ form.email }}"
                {% endif %}
                autocorrect="off"
                autocapitalize="off"
              >
            </div>

            <div class="float__wrapper">
              <label for="CreatePassword">{{ 'customer.register.password' | t }}</label>
              <input
                type="password"
                name="customer[password]"
                id="CreatePassword"
                placeholder="{{ 'customer.register.password' | t }}"
                {% if form.errors contains 'password' %}
                  class="error"
                {% endif %}
              >
            </div>

            <button type="submit" class="btn--outline uppercase btn--full">
              {{ 'customer.register.submit' | t }}
            </button>
            <div class="form--additional">
              <a class="text-link uppercase" href="{{ routes.account_login_url }}">
                {{ 'layout.customer.log_in' | t }}
              </a>
            </div>
            <hr>
            <div class="form__legal">
              {{ 'shopify.online_store.spam_detection.disclaimer_html' | t }}
            </div>
          {% endform %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  async function verifyNPI(npi) {
    if (!/^\d{10}$/.test(npi)) {
      return { valid: false, reason: 'NPI number must be exactly 10 digits' };
    }

    try {
      const response = await fetch(
        `https://npi-check.angeloraphaelmendoza.workers.dev/?number=${encodeURIComponent(npi)}`
      );

      if (!response.ok) {
        return { valid: false, reason: 'NPI API request failed' };
      }

      const data = await response.json();

      if (data.valid) {
        return { valid: true, data: data.data };
      } else {
        return { valid: false, reason: data.reason || 'NPI not found' };
      }
    } catch (error) {
      return { valid: false, reason: 'Network error: ' + error.message };
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    const form = document.querySelector('#CreateCustomerForm'); // check actual id in HTML
    const npiVerificationStatus = document.querySelector('.npi-verification-status');
    const loadingSpan = npiVerificationStatus.querySelector('.loading');
    const validSpan = npiVerificationStatus.querySelector('.valid');
    const invalidSpan = npiVerificationStatus.querySelector('.invalid');

    form.addEventListener(
      'submit',
      async function (e) {
        e.stopImmediatePropagation();
        e.preventDefault();

        npiVerificationStatus.classList.remove('hidden');
        loadingSpan.classList.remove('hidden');
        invalidSpan.classList.add('hidden');
        validSpan.classList.add('hidden');

        const npi = document.getElementById('NPI').value.trim();

        const isValid = await verifyNPI(npi);

        if (isValid.valid) {
          validSpan.classList.remove('hidden');
          invalidSpan.classList.add('hidden');
          loadingSpan.classList.add('hidden');
          form.submit(); // Submit the form if NPI is valid
        } else {
          invalidSpan.classList.remove('hidden');
          validSpan.classList.add('hidden');
          loadingSpan.classList.add('hidden');
        }
      },
      true
    );
  });
</script>
